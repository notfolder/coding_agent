version: '3.6'
services:
  # FastAPI（REST API）サーバー
  user-config-api:
    build:
      context: ./user_config_api
      dockerfile: Dockerfile
    container_name: user-config-api
    # Docker内部ネットワークのみで使用(外部公開不要)
    # テスト用に外部アクセスが必要な場合のみ、以下のコメントを外す
    ports:
      - "8081:8080"
    environment:
      - AD_BIND_PASSWORD=${AD_BIND_PASSWORD:-admin_password}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      - API_SERVER_KEY=${API_SERVER_KEY:-your-secret-api-key-here}
      - DATABASE_URL=sqlite:///./data/users.db
      - TASK_DB_URL=${TASK_DB_URL:-postgresql://coding_agent:${POSTGRES_PASSWORD:-coding_agent_password}@postgres:5432/coding_agent}
      - USE_MOCK_AD=${USE_MOCK_AD:-false}
    volumes:
      - user-config-data:/app/data
    networks:
      - coding-agent-network
    depends_on:
      postgres:
        condition: service_healthy

  # Streamlit管理画面サーバー
  user-config-web:
    build:
      context: ./user_config_api
      dockerfile: Dockerfile.streamlit
    container_name: user-config-web
    environment:
      - AD_BIND_PASSWORD=${AD_BIND_PASSWORD:-admin_password}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      - DATABASE_URL=sqlite:///./data/users.db
      - TASK_DB_URL=${TASK_DB_URL:-postgresql://coding_agent:${POSTGRES_PASSWORD:-coding_agent_password}@postgres:5432/coding_agent}
      - USE_MOCK_AD=${USE_MOCK_AD:-false}
    volumes:
      - user-config-data:/app/data
    ports:
      - "8501:8501"
    networks:
      - coding-agent-network
    depends_on:
      - user-config-api
      - openldap
      - postgres

  # テスト用OpenLDAPサーバー
  openldap:
    image: osixia/openldap:1.5.0
    container_name: openldap
    hostname: ldap.example.com
    environment:
      - LDAP_ORGANISATION=Example Inc
      - LDAP_DOMAIN=example.com
      - LDAP_ADMIN_PASSWORD=admin_password
      - LDAP_CONFIG_PASSWORD=config_password
      - LDAP_READONLY_USER=true
      - LDAP_READONLY_USER_USERNAME=readonly
      - LDAP_READONLY_USER_PASSWORD=readonly_password
      - LDAP_TLS_VERIFY_CLIENT=never
    volumes:
      - openldap-data:/var/lib/ldap
      - openldap-config:/etc/ldap/slapd.d
    ports:
      - "389:389"
      - "636:636"
    networks:
      - coding-agent-network

  # テスト用LDAP管理画面（LAM）
  ldap-account-manager:
    image: ldapaccountmanager/lam:stable
    container_name: ldap-account-manager
    environment:
      - LDAP_DOMAIN=example.com
      - LDAP_BASE_DN=dc=example,dc=com
      - LDAP_USERS_DN=ou=people,dc=example,dc=com
      - LDAP_GROUPS_DN=ou=groups,dc=example,dc=com
      - LDAP_SERVER=ldap://openldap:389
      - LAM_LANG=ja_JP
      - LAM_PASSWORD=lam_password
    ports:
      - "8090:80"
    networks:
      - coding-agent-network
    depends_on:
      - openldap

  web:
    image: 'gitlab/gitlab-ce:18.5.3-ce.0'
    restart: always
    ports:
      - '8080:80'
      - '8443:443'
      - '2222:22'
    volumes:
      - './gitlab/config:/etc/gitlab'
      - './gitlab/logs:/var/log/gitlab'
      - './gitlab/data:/var/opt/gitlab'
    shm_size: '256m'
    networks:
      - coding-agent-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/-/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

  rabbitmq:
    image: rabbitmq:3-management
    restart: always
    ports:
      - '5672:5672'   # AMQP
      - '15672:15672' # 管理Web
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - coding-agent-network

  # PostgreSQL - タスク情報の永続化
  postgres:
    image: postgres:16
    container_name: postgres
    restart: always
    ports:
      - '5432:5432'
    environment:
      POSTGRES_DB: coding_agent
      POSTGRES_USER: coding_agent
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-coding_agent_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - coding-agent-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U coding_agent -d coding_agent"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Producer サービス - タスクを継続的に取得してキューに追加
  coding-agent-producer:
    build: .
    container_name: coding-agent-producer
    command: ["python", "main.py", "--mode", "producer", "--continuous"]
    depends_on:
      rabbitmq:
        condition: service_started
      user-config-api:
        condition: service_started
      web:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - coding-agent-network
    environment:
      # 必須環境変数
      - TASK_SOURCE=${TASK_SOURCE:-github}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
      - GITLAB_PERSONAL_ACCESS_TOKEN=${GITLAB_PERSONAL_ACCESS_TOKEN:-}
      - GITLAB_API_URL=${GITLAB_API_URL:-https://gitlab.com/api/v4}
      - GITLAB_BOT_NAME=${GITLAB_BOT_NAME:-bot}
      - GITHUB_BOT_NAME=${GITHUB_BOT_NAME:-bot}

      # RabbitMQ設定
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=guest
      - RABBITMQ_PASSWORD=guest

      # PostgreSQL設定
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=coding_agent
      - DATABASE_USER=coding_agent
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-coding_agent_password}

      # LLM設定
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}

      # User Config API設定
      - USE_USER_CONFIG_API=${USE_USER_CONFIG_API:-false}
      - USER_CONFIG_API_URL=${USER_CONFIG_API_URL:-http://user-config-api:8080}
      - USER_CONFIG_API_KEY=${USER_CONFIG_API_KEY:-your-secret-api-key}

      # ログ設定
      - LOGS=/app/logs/producer.log
      - DEBUG=${DEBUG:-false}
    volumes:
      - ./logs:/app/logs
      - ./contexts:/app/contexts
      - ./healthcheck:/app/healthcheck
      - /var/run/docker.sock:/var/run/docker.sock  # Docker in Docker用
    restart: unless-stopped
    # gracefulシャットダウンの猶予時間
    stop_grace_period: 300s
    healthcheck:
      test: ["CMD", "python", "-c", "import os, time; f='/app/healthcheck/producer.health'; exit(0 if os.path.exists(f) and time.time() - os.path.getmtime(f) < 600 else 1)"]
      interval: 300s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Consumer サービス - キューからタスクを継続的に取得して処理
  coding-agent-consumer:
    build: .
    container_name: coding-agent-consumer
    command: ["python", "main.py", "--mode", "consumer", "--continuous"]
    depends_on:
      rabbitmq:
        condition: service_started
      user-config-api:
        condition: service_started
      web:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - coding-agent-network
    environment:
      # 必須環境変数
      - TASK_SOURCE=${TASK_SOURCE:-github}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
      - GITLAB_PERSONAL_ACCESS_TOKEN=${GITLAB_PERSONAL_ACCESS_TOKEN:-}
      - GITLAB_API_URL=${GITLAB_API_URL:-https://gitlab.com/api/v4}
      - GITLAB_BOT_NAME=${GITLAB_BOT_NAME:-bot}
      - GITHUB_BOT_NAME=${GITHUB_BOT_NAME:-bot}

      # RabbitMQ設定
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=guest
      - RABBITMQ_PASSWORD=guest

      # PostgreSQL設定
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=coding_agent
      - DATABASE_USER=coding_agent
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-coding_agent_password}

      # LLM設定
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}

      # User Config API設定
      - USE_USER_CONFIG_API=${USE_USER_CONFIG_API:-false}
      - USER_CONFIG_API_URL=${USER_CONFIG_API_URL:-http://user-config-api:8080}
      - USER_CONFIG_API_KEY=${USER_CONFIG_API_KEY:-your-secret-api-key}

      # ログ設定
      - LOGS=/app/logs/consumer.log
      - DEBUG=${DEBUG:-false}
    volumes:
      - ./logs:/app/logs
      - ./contexts:/app/contexts
      - ./healthcheck:/app/healthcheck
      - /var/run/docker.sock:/var/run/docker.sock  # Docker in Docker用
    restart: unless-stopped
    # gracefulシャットダウンの猶予時間(タスク処理完了を待つ)
    # 注: タスク処理に時間がかかる場合(LLM呼び出し、ファイル操作等)、
    # 処理中のタスクを完了させるために十分な時間を確保する必要があります。
    # デフォルト: 300秒(5分)
    # - 短時間タスクが多い場合: 60s〜120s に短縮可能
    # max_llm_process_numの設定値と平均処理時間を考慮して調整してください。
    stop_grace_period: 300s
    healthcheck:
      test: ["CMD", "python", "-c", "import os, time; f='/app/healthcheck/consumer.health'; exit(0 if os.path.exists(f) and time.time() - os.path.getmtime(f) < 600 else 1)"]
      interval: 300s
      timeout: 10s
      retries: 3
      start_period: 30s

  # === 実行環境イメージ（ビルド専用、executor-buildプロファイル） ===
  # 計画フェーズでLLMが選択する実行環境イメージ
  # ビルドコマンド: docker compose --profile executor-build build

  # Python実行環境イメージ
  executor-python:
    build:
      context: ./docker/executor-python
      dockerfile: Dockerfile
    image: coding-agent-executor-python:latest
    command: ["echo", "Build only"]

  # Miniforge（conda）実行環境イメージ
  executor-miniforge:
    build:
      context: ./docker/executor-miniforge
      dockerfile: Dockerfile
    image: coding-agent-executor-miniforge:latest
    command: ["echo", "Build only"]

  # Node.js実行環境イメージ
  executor-node:
    build:
      context: ./docker/executor-node
      dockerfile: Dockerfile
    image: coding-agent-executor-node:latest
    command: ["echo", "Build only"]

volumes:
  rabbitmq_data:
  postgres_data:
  user-config-data:
  openldap-data:
  openldap-config:

networks:
  coding-agent-network:
    driver: bridge
