version: '3.6'
services:
  user-config-api:
    build: ./user_config_api
    container_name: user-config-api
    # Docker内部ネットワークのみで使用（外部公開不要）
    # テスト用に外部アクセスが必要な場合のみ、以下のコメントを外す
    ports:
      - "8081:8080"
    environment:
      API_SERVER_KEY: ${API_SERVER_KEY:-your-secret-api-key-here}

  web:
    image: 'gitlab/gitlab-ce:latest'
    restart: always
    ports:
      - '8080:80'
      - '8443:443'
      - '2222:22'
    volumes:
      - './gitlab/config:/etc/gitlab'
      - './gitlab/logs:/var/log/gitlab'
      - './gitlab/data:/var/opt/gitlab'
    shm_size: '256m'

  rabbitmq:
    image: rabbitmq:3-management
    restart: always
    ports:
      - '5672:5672'   # AMQP
      - '15672:15672' # 管理Web
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  webhook-server:
    build: .
    container_name: coding-agent-webhook
    restart: unless-stopped
    ports:
      - '8000:8000'
    environment:
      WEBHOOK_ENABLED: "true"
      WEBHOOK_SERVER_HOST: "0.0.0.0"
      WEBHOOK_SERVER_PORT: "8000"
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET}
      GITLAB_WEBHOOK_TOKEN: ${GITLAB_WEBHOOK_TOKEN}
      GITLAB_SYSTEM_HOOK_TOKEN: ${GITLAB_SYSTEM_HOOK_TOKEN}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: "5672"
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      USE_RABBITMQ: "true"
    depends_on:
      - rabbitmq
    command: ["--mode", "webhook"]

  task-consumer:
    build: .
    container_name: coding-agent-consumer
    restart: unless-stopped
    environment:
      TASK_SOURCE: ${TASK_SOURCE:-github}
      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_PERSONAL_ACCESS_TOKEN}
      GITLAB_PERSONAL_ACCESS_TOKEN: ${GITLAB_PERSONAL_ACCESS_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: "5672"
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      USE_RABBITMQ: "true"
    depends_on:
      - rabbitmq
    command: ["--mode", "consumer"]

volumes:
  rabbitmq_data:
