# LLM呼び出し時のIssueコメント仕様書

## 1. 概要

### 1.1 目的

本仕様書は、計画モード（Planning Mode）でLLM呼び出しが発生するたびに、Issue/MRに進捗状況をコメントとして投稿する機能の詳細設計を定義します。これにより、ユーザーは各段階で何が行われているか、その結果がどうであったかをリアルタイムで把握できるようになります。

### 1.2 スコープ

本仕様は以下をカバーします：

- LLM呼び出しごとのIssueコメント投稿の仕組み
- コメント内容のフォーマット
- LLM応答内の`comment`フィールドの活用方法
- エラー時のコメント処理

### 1.3 前提条件

- 計画モード（Planning Mode）が有効であること
- Task オブジェクトが `comment()` メソッドをサポートしていること
- LLM クライアントが `get_response()` で応答を返すこと

---

## 2. 現状分析

### 2.1 現在のコメント投稿ポイント

現在の `PlanningCoordinator` では以下のタイミングでコメントが投稿されています：

1. **フェーズ開始/完了時** (`_post_phase_comment`)
   - pre_planning、planning、execution、reflection、revision、verificationの各フェーズ
   
2. **計画チェックリスト投稿** (`_post_plan_as_checklist`)
   - 計画完了時にMarkdownチェックリストとして投稿
   
3. **進捗更新** (`_update_checklist_progress`)
   - 各アクション完了時にチェックリストを更新

4. **エラー発生時**
   - ツール実行エラー時にエラー内容を投稿

5. **LLM応答の`comment`フィールド**
   - アクション実行結果にcommentがある場合に投稿

### 2.2 現状の課題

- LLM呼び出しの度に何をしているかが可視化されていない
- LLM呼び出しの結果（概要）がユーザーに伝わらない
- 特に計画フェーズやリフレクションフェーズでの進捗が不透明

---

## 3. 設計方針

### 3.1 基本方針

各LLM呼び出し完了時に以下の情報をIssue/MRにコメントとして投稿する：

1. **LLM応答に`comment`フィールドがある場合**: その内容を使用（常に優先）
2. **LLM応答に`comment`フィールドがない場合**: フェーズ名と何回目のLLM呼び出しが完了したかを報告

### 3.2 コメント内容の決定ルール

LLM応答の処理において以下のルールでコメント内容を決定する：

1. LLM応答に`comment`フィールドが含まれる場合、**常にその内容を使用**
2. `comment`フィールドがない場合、フェーズごとのデフォルトメッセージ（LLM呼び出し回数を含む）を使用

---

## 4. 詳細設計

### 4.1 LLM呼び出しコメントの構造

#### 4.1.1 呼び出し完了時のコメント形式

LLM応答受信後、以下の形式でコメントを投稿する：

**LLM応答に`comment`フィールドがある場合**:

```
## ✅ {フェーズ名} - LLM呼び出し #{呼び出し回数}

{LLM応答のcommentフィールドの内容}

*{タイムスタンプ}*
```

**LLM応答に`comment`フィールドがない場合**:

```
## ✅ {フェーズ名} - LLM呼び出し #{呼び出し回数} 完了

{フェーズに応じたデフォルトメッセージ}

*{タイムスタンプ}*
```

### 4.2 フェーズ別のデフォルトメッセージ

各フェーズでLLM応答に`comment`フィールドがない場合に使用するデフォルトメッセージ：

| フェーズ | デフォルトメッセージ |
|---------|---------------------|
| 計画前情報収集 (Pre-Planning) | タスク内容の分析と情報収集が完了しました |
| 計画作成 (Planning) | 実行計画の作成が完了しました |
| アクション実行 (Execution) | アクション「{task_id}」の実行が完了しました |
| リフレクション (Reflection) | 実行結果の分析が完了しました |
| 計画修正 (Revision) | 計画の修正が完了しました |
| 検証 (Verification) | 実装の検証が完了しました |
| 再計画判断 (Replan Decision) | 再計画の判断が完了しました |

### 4.3 LLM呼び出し回数のトラッキング

#### 4.3.1 カウンターの管理

`PlanningCoordinator`クラスに以下のカウンターを追加する：

- `llm_call_count`: 全体のLLM呼び出し回数
- 各LLM呼び出し完了時にインクリメント

#### 4.3.2 カウンターのリセットタイミング

- タスク開始時に0にリセット
- 一時停止/再開時はカウンターを保持（状態の一部として保存）

### 4.4 LLM応答のcommentフィールド活用

#### 4.4.1 commentフィールドの検出と利用

LLM応答がJSON形式の場合、`comment`フィールドの存在をチェックし、存在する場合はその内容をIssue/MRに投稿する。

**処理フロー**:

1. LLM応答を取得
2. JSON形式の場合、パースして`comment`フィールドを探索
3. `comment`フィールドが存在し、空でない場合:
   - そのまま内容をIssue/MRにコメントとして投稿
4. `comment`フィールドが存在しない場合:
   - フェーズに応じたデフォルトメッセージを投稿

#### 4.4.2 システムプロンプトへの指示追加

LLMが適切なcommentを生成するよう、システムプロンプトに以下の指示を追加する：

```
You can optionally include a "comment" field in your response.
This field should contain a progress update or summary of results that you want to communicate to the user.
Write the comment in Japanese. This comment will be automatically posted to the GitHub/GitLab Issue.
```

### 4.5 エラー時のコメント処理

#### 4.5.1 ツール実行エラー

ツール実行でエラーが発生した場合、以下のコメントを投稿する：

```
## ❌ エラー発生 - {ツール名}

**エラー内容**: {エラーメッセージ}

**発生したアクション**: {task_id}

*{タイムスタンプ}*
```

#### 4.5.2 LLM応答エラー

LLM呼び出し自体が失敗した場合、以下のコメントを投稿する：

```
## ⚠️ LLM呼び出しエラー - {フェーズ名}

**エラー内容**: {エラーメッセージ}

リトライを試みます...

*{タイムスタンプ}*
```

---

## 5. 実装上の考慮事項

### 5.1 既存コメントの更新

同一フェーズ内での進捗更新は、新規コメント投稿ではなく既存コメントの更新で対応：

- フェーズ開始時のコメントIDを保持
- 完了時にそのコメントを更新して結果を追記
- これにより、コメント数の増加を抑制

### 5.2 エラーハンドリング

コメント投稿はAPI呼び出しを伴うため、以下を考慮：

- コメント投稿失敗時のリトライ制限（最大3回）
- コメント投稿失敗がメイン処理に影響しないエラーハンドリング

---

## 6. 設定例

```yaml
planning:
  enabled: true
  llm_call_comments:
    enabled: true    # LLM呼び出しコメント機能の有効/無効
```

---

## 7. コメント例

### 7.1 LLM応答にcommentフィールドがある場合

```markdown
## ✅ 計画作成 - LLM呼び出し #2

タスク「新機能の実装」を分析し、以下の計画を作成しました：

1. 既存コードの調査（2アクション）
2. 新機能の実装（3アクション）
3. テストの作成（2アクション）

合計7つのアクションで実装を進めます。

*2025-01-17 14:30:45*
```

### 7.2 LLM応答にcommentフィールドがない場合

```markdown
## ✅ アクション実行 - LLM呼び出し #5 完了

アクション「task_3」の実行が完了しました

*2025-01-17 14:32:30*
```

### 7.3 エラー発生時の例

```markdown
## ❌ エラー発生 - github_create_file

**エラー内容**: ファイルが既に存在します: src/existing.py

**発生したアクション**: task_3

リトライまたは代替アプローチを検討しています...

*2025-01-17 14:33:00*
```

---

## 8. 関連ドキュメント

- [プランニングプロセス仕様](PLANNING_SPECIFICATION.md)
- [再計画仕様](REPLANNING_SPECIFICATION.md)
- [計画前情報収集仕様](PRE_PLANNING_INFORMATION_GATHERING_SPECIFICATION.md)

---

**文書バージョン:** 2.0  
**最終更新日:** 2025-01-29  
**ステータス:** 設計完了
