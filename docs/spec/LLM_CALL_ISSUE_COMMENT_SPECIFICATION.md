# LLM呼び出し時のIssueコメント仕様書

## 1. 概要

### 1.1 目的

本仕様書は、計画モード（Planning Mode）でLLM呼び出しが発生するたびに、Issue/MRに進捗状況をコメントとして投稿する機能の詳細設計を定義します。これにより、ユーザーは各段階で何が行われているか、その結果がどうであったかをリアルタイムで把握できるようになります。

### 1.2 スコープ

本仕様は以下をカバーします：

- LLM呼び出しごとのIssueコメント投稿の仕組み
- コメント内容のフォーマットと種類
- LLM応答内の`comment`フィールドの活用方法
- コメント頻度の制御オプション
- エラー時のコメント処理

### 1.3 前提条件

- 計画モード（Planning Mode）が有効であること
- Task オブジェクトが `comment()` メソッドをサポートしていること
- LLM クライアントが `get_response()` で応答を返すこと

---

## 2. 現状分析

### 2.1 現在のコメント投稿ポイント

現在の `PlanningCoordinator` では以下のタイミングでコメントが投稿されています：

1. **フェーズ開始/完了時** (`_post_phase_comment`)
   - pre_planning、planning、execution、reflection、revision、verificationの各フェーズ
   
2. **計画チェックリスト投稿** (`_post_plan_as_checklist`)
   - 計画完了時にMarkdownチェックリストとして投稿
   
3. **進捗更新** (`_update_checklist_progress`)
   - 各アクション完了時にチェックリストを更新

4. **エラー発生時**
   - ツール実行エラー時にエラー内容を投稿

5. **LLM応答の`comment`フィールド**
   - アクション実行結果にcommentがある場合に投稿

### 2.2 現状の課題

- LLM呼び出しの度に何をしているかが可視化されていない
- LLM呼び出しの結果（概要）がユーザーに伝わらない
- 特に計画フェーズやリフレクションフェーズでの進捗が不透明

---

## 3. 設計方針

### 3.1 基本方針

各LLM呼び出し時に以下の情報をIssue/MRにコメントとして投稿する：

1. **呼び出し前**: 何を行おうとしているかの説明
2. **呼び出し後**: 結果の概要（LLM応答の`comment`フィールドを優先利用）

### 3.2 コメント内容の優先順位

LLM応答の処理において以下の優先順位でコメント内容を決定する：

1. **最優先**: LLM応答に`comment`フィールドが含まれる場合、その内容を使用
2. **次点**: LLM応答から自動生成されたサマリーを使用
3. **フォールバック**: デフォルトのフェーズ完了メッセージを使用

---

## 4. 詳細設計

### 4.1 LLM呼び出しコメントの構造

#### 4.1.1 呼び出し開始時のコメント形式

各LLM呼び出しの開始時に以下の形式でコメントを投稿する：

```
## 🤖 LLM呼び出し - {フェーズ名}

**目的**: {この呼び出しで何を行うか}

*{タイムスタンプ}*
```

フェーズ名と目的の組み合わせ例：

| フェーズ | 目的の説明 |
|---------|-----------|
| 計画前情報収集 | タスク内容を分析し、必要な情報を収集しています |
| 計画作成 | タスクを分析し、実行計画を作成しています |
| アクション実行 | アクション「{task_id}」を実行しています |
| リフレクション | 実行結果を分析し、計画の修正が必要か判断しています |
| 計画修正 | リフレクション結果に基づき計画を修正しています |
| 検証 | 実装の完全性を検証しています |
| 再計画判断 | エラーに基づき再計画が必要か判断しています |

#### 4.1.2 呼び出し完了時のコメント形式

LLM応答受信後、以下の形式でコメントを投稿する：

**LLM応答に`comment`フィールドがある場合**:

```
## ✅ 完了 - {フェーズ名}

{LLM応答のcommentフィールドの内容}

*{タイムスタンプ}*
```

**LLM応答に`comment`フィールドがない場合**:

```
## ✅ 完了 - {フェーズ名}

{自動生成されたサマリー}

**結果概要**:
- {キーポイント1}
- {キーポイント2}
- ...

*{タイムスタンプ}*
```

### 4.2 フェーズ別のコメント詳細

#### 4.2.1 計画前情報収集フェーズ (Pre-Planning)

**開始時のコメント**:
- 目的: タスク内容を分析し、必要な情報を収集している

**完了時のコメント内容**:
- タスク種別（新規実装、バグ修正、リファクタリング等）
- 理解した主な目標
- 収集した情報の概要
- 推測した内容があれば列挙

#### 4.2.2 計画作成フェーズ (Planning)

**開始時のコメント**:
- 目的: タスクの分析と実行計画の作成

**完了時のコメント内容**:
- 生成されたサブタスク数
- 推定される作業量（軽量/中程度/重量）
- 主要な作業項目の概要

#### 4.2.3 アクション実行フェーズ (Execution)

**開始時のコメント**:
- 実行中のアクションID
- アクションの目的
- 使用するツール名

**完了時のコメント内容**:
- 実行結果（成功/失敗）
- LLM応答のcommentフィールド（ある場合）
- 次のアクションの予告（ある場合）

#### 4.2.4 リフレクションフェーズ (Reflection)

**開始時のコメント**:
- 目的: 実行結果の分析と計画修正の判断

**完了時のコメント内容**:
- 評価結果の概要
- 計画修正が必要かどうか
- 特定された問題点（ある場合）

#### 4.2.5 計画修正フェーズ (Revision)

**開始時のコメント**:
- 目的: リフレクション結果に基づく計画修正

**完了時のコメント内容**:
- 修正された計画の概要
- 変更されたアクション数
- 修正理由

#### 4.2.6 検証フェーズ (Verification)

**開始時のコメント**:
- 目的: 実装完全性の検証

**完了時のコメント内容**:
- 検証結果（合格/不合格）
- 検出された問題数
- 追加作業が必要かどうか

### 4.3 コメント頻度の制御

#### 4.3.1 設定オプション

`config.yaml`のplanningセクションに以下の設定を追加する：

```yaml
planning:
  llm_call_comments:
    enabled: true                    # LLM呼び出しコメント機能の有効/無効
    comment_level: "summary"         # "detailed" | "summary" | "minimal"
    start_comment: true              # 呼び出し開始時のコメントを投稿するか
    completion_comment: true         # 呼び出し完了時のコメントを投稿するか
    prefer_llm_comment: true         # LLM応答のcommentフィールドを優先するか
    batch_interval: 0                # コメントをバッチ処理する間隔（秒）、0で即時投稿
```

#### 4.3.2 コメントレベルの定義

| レベル | 説明 |
|--------|------|
| detailed | すべてのLLM呼び出しに対して詳細なコメントを投稿 |
| summary | 主要なフェーズのみコメントを投稿（計画、検証、エラー時） |
| minimal | エラー時とLLM応答にcommentがある場合のみ投稿 |

### 4.4 LLM応答のcommentフィールド活用

#### 4.4.1 commentフィールドの検出と利用

LLM応答がJSON形式の場合、`comment`フィールドの存在をチェックし、存在する場合はその内容をIssue/MRに投稿する。

**処理フロー**:

1. LLM応答を取得
2. JSON形式の場合、パースして`comment`フィールドを探索
3. `comment`フィールドが存在し、空でない場合:
   - そのまま内容をIssue/MRにコメントとして投稿
4. `comment`フィールドが存在しない場合:
   - 設定に応じて自動生成サマリーを投稿、または投稿をスキップ

#### 4.4.2 システムプロンプトへの指示追加

LLMが適切なcommentを生成するよう、システムプロンプトに以下の指示を追加する：

```
応答にはオプションで"comment"フィールドを含めることができます。
このフィールドには、ユーザーに伝えたい進捗状況や結果の概要を
日本語で記述してください。このコメントはGitHub/GitLabのIssueに
自動的に投稿されます。
```

### 4.5 エラー時のコメント処理

#### 4.5.1 ツール実行エラー

ツール実行でエラーが発生した場合、以下のコメントを投稿する：

```
## ❌ エラー発生 - {ツール名}

**エラー内容**: {エラーメッセージ}

**発生したアクション**: {task_id}

*{タイムスタンプ}*
```

#### 4.5.2 LLM応答エラー

LLM呼び出し自体が失敗した場合、以下のコメントを投稿する：

```
## ⚠️ LLM呼び出しエラー - {フェーズ名}

**エラー内容**: {エラーメッセージ}

リトライを試みます...

*{タイムスタンプ}*
```

---

## 5. 実装上の考慮事項

### 5.1 コメントの重複回避

同一内容のコメントが連続して投稿されないよう、以下の対策を講じる：

- 直前のコメント内容をキャッシュし、同一内容の場合は投稿をスキップ
- フェーズ開始コメントと完了コメントを統合するオプションの提供

### 5.2 コメント量の制御

Issue/MRにコメントが大量に投稿されることを防ぐため：

- `batch_interval`設定により、一定時間内のコメントをまとめて投稿
- `comment_level`設定により、投稿頻度を制御
- 長い処理の場合、進捗率（%）のみを定期的に更新

### 5.3 既存コメントの更新

同一フェーズ内での進捗更新は、新規コメント投稿ではなく既存コメントの更新で対応：

- フェーズ開始時のコメントIDを保持
- 完了時にそのコメントを更新して結果を追記
- これにより、コメント数の増加を抑制

### 5.4 パフォーマンスへの影響

コメント投稿はAPI呼び出しを伴うため、以下を考慮：

- 非同期でのコメント投稿（メイン処理をブロックしない）
- コメント投稿失敗時のリトライ制限（最大3回）
- コメント投稿失敗がメイン処理に影響しないエラーハンドリング

---

## 6. 設定例

### 6.1 詳細モード（全コメント表示）

```yaml
planning:
  enabled: true
  llm_call_comments:
    enabled: true
    comment_level: "detailed"
    start_comment: true
    completion_comment: true
    prefer_llm_comment: true
    batch_interval: 0
```

### 6.2 サマリーモード（主要フェーズのみ）

```yaml
planning:
  enabled: true
  llm_call_comments:
    enabled: true
    comment_level: "summary"
    start_comment: false
    completion_comment: true
    prefer_llm_comment: true
    batch_interval: 0
```

### 6.3 最小モード（エラーとLLMコメントのみ）

```yaml
planning:
  enabled: true
  llm_call_comments:
    enabled: true
    comment_level: "minimal"
    start_comment: false
    completion_comment: false
    prefer_llm_comment: true
    batch_interval: 0
```

---

## 7. コメント例

### 7.1 計画作成フェーズの例

**開始時**:
```markdown
## 🤖 LLM呼び出し - 計画作成

**目的**: タスクを分析し、実行計画を作成しています

*2025-01-17 14:30:15*
```

**完了時（LLMのcommentフィールドを使用）**:
```markdown
## ✅ 完了 - 計画作成

タスク「新機能の実装」を分析し、以下の計画を作成しました：

1. 既存コードの調査（2アクション）
2. 新機能の実装（3アクション）
3. テストの作成（2アクション）

合計7つのアクションで実装を進めます。

*2025-01-17 14:30:45*
```

### 7.2 アクション実行フェーズの例

**開始時**:
```markdown
## 🤖 LLM呼び出し - アクション実行

**目的**: アクション「task_3」を実行しています
**ツール**: github_create_file
**内容**: 新しいモジュールファイルの作成

*2025-01-17 14:32:00*
```

**完了時**:
```markdown
## ✅ 完了 - アクション実行

`src/new_feature.py`を作成しました。
基本的なクラス構造と主要なメソッドの骨格を実装しました。
次のアクションでテストコードを作成します。

*2025-01-17 14:32:30*
```

### 7.3 エラー発生時の例

```markdown
## ❌ エラー発生 - github_create_file

**エラー内容**: ファイルが既に存在します: src/existing.py

**発生したアクション**: task_3

リトライまたは代替アプローチを検討しています...

*2025-01-17 14:33:00*
```

---

## 8. 関連ドキュメント

- [プランニングプロセス仕様](PLANNING_SPECIFICATION.md)
- [再計画仕様](REPLANNING_SPECIFICATION.md)
- [計画前情報収集仕様](PRE_PLANNING_INFORMATION_GATHERING_SPECIFICATION.md)

---

**文書バージョン:** 1.0  
**最終更新日:** 2025-01-29  
**ステータス:** 設計完了
