# コンテキストストレージ実装仕様書

## 1. 概要

### 1.1 目的

本仕様書は、コンテキストファイル化仕様の実装詳細を定義します。

### 1.2 対象

- TaskContextManagerの実装詳細
- MessageStoreの実装詳細
- データベース操作の詳細
- ファイル操作の詳細

---

## 2. TaskContextManager実装

### 2.1 初期化処理

TaskContextManagerの初期化時に以下の処理を実行します：

1. タスクUUIDの検証
2. コンテキストディレクトリの作成（running/{uuid}/）
3. metadata.jsonの作成
4. tasks.dbへのレコード挿入
5. サブストア（MessageStore、SummaryStore、ToolStore）の初期化

### 2.2 状態管理

タスクの状態はtasks.dbで管理します。ステータスの遷移は以下の通りです：

- running: タスク実行中
- completed: タスク完了
- failed: タスク失敗
- paused: 一時停止中

### 2.3 ディレクトリ移動

タスク完了時または失敗時に、コンテキストディレクトリを移動します：

- 正常完了: running/{uuid}/ → completed/{uuid}/
- 失敗: running/{uuid}/ → completed/{uuid}/
- 一時停止: running/{uuid}/ → paused/{uuid}/

---

## 3. MessageStore実装

### 3.1 ファイル形式

#### messages.jsonl

全メッセージ履歴を保存します。各行は以下のフィールドを含むJSONオブジェクトです：

- seq: シーケンス番号
- role: メッセージロール
- content: メッセージ内容
- timestamp: タイムスタンプ
- tokens: 推定トークン数
- tool_name: ツール名（オプション）

#### current.jsonl

現在のコンテキストを保存します。OpenAI API互換形式で、以下のフィールドのみを含みます：

- role: メッセージロール
- content: メッセージ内容
- tool_name: ツール名（オプション）

### 3.2 トークン数計算

トークン数は文字数を4で割った値として推定します。日本語の場合は文字数を2で割った値を使用します。

### 3.3 コンテキスト再構築

圧縮後のコンテキスト再構築手順：

1. current.jsonlを削除
2. 要約を最初の行として書き込み
3. unsummarized.jsonlの内容を追記
4. unsummarized.jsonlを削除

---

## 4. データベース操作

### 4.1 SQLite設定

以下の設定でSQLiteを使用します：

- WALモード: 有効
- 同期モード: NORMAL
- ジャーナルサイズ: 制限なし

### 4.2 接続管理

接続プールは使用せず、各操作ごとに接続を開閉します。1タスク1プロセスの前提のため、排他制御は不要です。

### 4.3 エラーリトライ

データベース操作エラー時は最大3回リトライします。リトライ間隔は指数バックオフを使用します。

---

## 5. ファイル操作

### 5.1 JSONLの追記

JSONLファイルへの追記は以下の手順で行います：

1. ファイルを追記モードで開く
2. JSONオブジェクトを文字列化
3. 改行を付加して書き込み
4. ファイルを閉じる

### 5.2 ファイル結合

複数のJSONLファイルを結合する場合、ストリーム処理を使用してメモリ消費を抑えます。

### 5.3 アトミック操作

ファイル操作はできる限りアトミックに行います。一時ファイルを作成し、完了後にリネームする方式を採用します。

---

## 6. 関連ドキュメント

- [コンテキストファイル化仕様](context_file_spec.md)

---

**文書バージョン:** 2.0  
**最終更新日:** 2024-11-28  
**ステータス:** 実装済み
